<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CSCRF Knowledge Graph</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #050814;
      color: #f0f0f0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    #graph {
      width: 100vw;
      height: 100vh;
    }
    .link {
      stroke: #888;
      stroke-opacity: 0.6;
    }
    .node circle {
      stroke: #fff;
      stroke-width: 1px;
      cursor: pointer;
    }
    .label {
      fill: #e0e0e0;
      font-size: 10px;
      pointer-events: none;
    }
    .legend {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0,0,0,0.6);
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 11px;
      line-height: 1.4;
      z-index: 10;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 2px;
    }
    .legend-swatch {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 1px solid #fff;
    }
  </style>
</head>
<body>
  <div class="legend">
    <div class="legend-item">
      <span class="legend-swatch" style="background:#ffcc00;"></span> Goal
    </div>
    <div class="legend-item">
      <span class="legend-swatch" style="background:#ff7f0e;"></span> Control
    </div>
    <div class="legend-item">
      <span class="legend-swatch" style="background:#1f77b4;"></span> Standard
    </div>
    <div class="legend-item">
      <span class="legend-swatch" style="background:#2ca02c;"></span> Guideline
    </div>
    <div class="legend-item">
      <span class="legend-swatch" style="background:#d62728;"></span> Applicability
    </div>
  </div>

  <svg id="graph"></svg>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    const colorByType = {
      "Goal": "#ffcc00",
      "Control": "#ff7f0e",
      "Standard": "#1f77b4",
      "Guideline": "#2ca02c",
      "ApplicabilityGroup": "#d62728"
    };

    const svg = d3.select("#graph");
    const width = window.innerWidth;
    const height = window.innerHeight;

    // HTML tooltip
    const tooltip = d3.select("body")
      .append("div")
      .attr("class", "tooltip")
      .style("position", "absolute")
      .style("pointer-events", "none")
      .style("background", "rgba(0,0,0,0.9)")
      .style("color", "#f0f0f0")
      .style("padding", "6px 8px")
      .style("border-radius", "4px")
      .style("font-size", "11px")
      .style("max-width", "360px")
      .style("line-height", "1.3")
      .style("opacity", 0);

    // Zoom + pan
    const zoomLayer = svg.append("g");
    svg.call(
      d3.zoom()
        .scaleExtent([0.1, 4])
        .on("zoom", (event) => {
          zoomLayer.attr("transform", event.transform);
        })
    );

    fetch("./graph.json")
      .then(r => r.json())
      .then(graph => {
        const simulation = d3.forceSimulation(graph.nodes)
          .force("link", d3.forceLink(graph.links).id(d => d.id).distance(90))
          .force("charge", d3.forceManyBody().strength(-220))
          .force("center", d3.forceCenter(width / 2, height / 2))
          .force("collision", d3.forceCollide().radius(20));

        const link = zoomLayer.append("g")
            .attr("stroke-width", 1)
          .selectAll("line")
          .data(graph.links)
          .join("line")
            .attr("class", "link");

        const node = zoomLayer.append("g")
          .selectAll("g")
          .data(graph.nodes)
          .join("g")
            .attr("class", "node")
            .call(
              d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended)
            );

        node.append("circle")
          .attr("r", 6)
          .attr("fill", d => colorByType[d.type] || "#ccc");

        node.append("text")
          .attr("class", "label")
          .attr("x", 8)
          .attr("y", 3)
          .text(d => d.label || d.id);

        // -------- Neighborhood / focus logic --------

        // Build neighbor map: node id -> Set of neighbor ids (including self)
        const neighborMap = new Map();
        graph.nodes.forEach(n => neighborMap.set(n.id, new Set([n.id])));
        graph.links.forEach(l => {
          const src = typeof l.source === "object" ? l.source.id : l.source;
          const tgt = typeof l.target === "object" ? l.target.id : l.target;
          neighborMap.get(src).add(tgt);
          neighborMap.get(tgt).add(src);
        });

        let focusedNodeId = null;

        function isNeighbor(aId, bId) {
          const set = neighborMap.get(aId);
          return set ? set.has(bId) : false;
        }

        function updateFocus() {
          if (!focusedNodeId) {
            node.style("opacity", 1);
            link.style("opacity", 0.6);
            return;
          }

          node.style("opacity", d =>
            isNeighbor(focusedNodeId, d.id) ? 1 : 0.05
          );

          link.style("opacity", d => {
            const sId = d.source.id || d.source;
            const tId = d.target.id || d.target;
            return (isNeighbor(focusedNodeId, sId) &&
                    isNeighbor(focusedNodeId, tId))
              ? 0.8
              : 0.03;
          });
        }

        // Node events: click isolates subgraph, hover shows tooltip
        node
          .on("click", (event, d) => {
            if (focusedNodeId === d.id) {
              focusedNodeId = null;
            } else {
              focusedNodeId = d.id;
            }
            updateFocus();
            event.stopPropagation();
          })
          .on("mouseover", (event, d) => {
            const html = buildTooltipHtml(d);
            tooltip.html(html).style("opacity", 1);
          })
          .on("mousemove", (event) => {
            tooltip
              .style("left", (event.pageX + 10) + "px")
              .style("top", (event.pageY + 10) + "px");
          })
          .on("mouseout", () => {
            tooltip.style("opacity", 0);
          });

        // Click on empty canvas â†’ reset focus
        svg.on("click", () => {
          focusedNodeId = null;
          updateFocus();
        });

        simulation.on("tick", () => {
          link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

          node.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        function dragstarted(event, d) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        }
        function dragged(event, d) {
          d.fx = event.x;
          d.fy = event.y;
        }
        function dragended(event, d) {
          if (!event.active) simulation.alphaTarget(0);
          d.fx = null;
          d.fy = null;
        }

        function buildTooltipHtml(d) {
          const title = d.label || d.id;
          let extra = "";

          if (d.type === "Guideline") {
            extra = d.text || "";
          } else if (d.type === "Standard") {
            extra = d.code || d.id || "";
          } else if (d.type === "Control") {
            extra = d.name || d.code || "";
          } else if (d.type === "Goal") {
            extra = d.name || d.label || "";
          } else if (d.type === "ApplicabilityGroup") {
            extra = d.label || "";
          }

          if (extra && extra !== title) {
            return `<strong>${d.type}</strong><br/><strong>${escapeHtml(title)}</strong>` +
                   `<br/><hr style="border:0;border-top:1px solid #555;margin:4px 0;"/>` +
                   `<div>${escapeHtml(extra)}</div>`;
          }
          return `<strong>${d.type}</strong><br/><strong>${escapeHtml(title)}</strong>`;
        }

        function escapeHtml(str) {
          if (!str) return "";
          return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
        }
      })
      .catch(err => {
        console.error("Error loading graph.json", err);
      });
  </script>
</body>
</html>
